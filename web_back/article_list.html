<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>文章列表</title>
		<link rel="stylesheet" href="js/bootstrap/css/bootstrap.min.css">
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/iconfont.css">
		<link rel="stylesheet" href="css/main.css">
		<script src="js/lib/jquery-1.12.4.min.js"></script>
	</head>

	<body>
		<div class="container-fluid">
			<div class="common_title">
				文章列表
			</div>
			<div class="container-fluid common_con">
				<div class="row opt_btns">
					<div class="col-xs-6">
						<form class="form-inline">
							<select id="selCategory" name="" class="form-control input-sm">

							</select>
							<select id="selStatus" name="" class="form-control input-sm">
								<option value="">所有状态</option>
								<option value="drafted">草稿</option>
								<option value="published">已发布</option>
							</select>
							<button id="btnSearch" class="btn btn-default btn-sm" type="button">筛选</button>
						</form>
					</div>
					<div class="col-xs-6">
						<a href="article_release.html" class="btn btn-success btn-sm pull-right" id="release_btn">发表文章</a>
					</div>
				</div>

				<table class="table table-striped table-bordered table-hover mp20">
					<thead>
						<tr>
							<th>标题</th>
							<th>作者</th>
							<th>分类</th>
							<th class="text-center">发表时间</th>
							<th class="text-center">状态</th>
							<th class="text-center" width="100">操作</th>
						</tr>
					</thead>
					<tbody id='listArticle'>

					</tbody>
				</table>

				<div class="row text-center">
					<ul class="pagination pagination-sm" id="pagination-demo">
						<li class="page-item first disabled">
							<a href="#" class="page-link">首页</a>
						</li>
						<li class="page-item prev disabled">
							<a href="#" class="page-link">上一页</a>
						</li>
						<li class="page-item active">
							<a href="#" class="page-link">1</a>
						</li>
						<li class="page-item">
							<a href="#" class="page-link">2</a>
						</li>
						<li class="page-item">
							<a href="#" class="page-link">3</a>
						</li>
						<li class="page-item">
							<a href="#" class="page-link">4</a>
						</li>
						<li class="page-item">
							<a href="#" class="page-link">5</a>
						</li>
						<li class="page-item">
							<a href="#" class="page-link">6</a>
						</li>
						<li class="page-item">
							<a href="#" class="page-link">7</a>
						</li>
						<li class="page-item next">
							<a href="#" class="page-link">下一页</a>
						</li>
						<li class="page-item last">
							<a href="#" class="page-link">尾页</a>
						</li>
					</ul>
				</div>

			</div>
		</div>
		<script src="js/utils/config_副本.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/utils/article.js"></script>
		<script src="js/utils/category.js"></script>
		<script src="js/lib/jquery.twbsPagination.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/lib/template-web.js" type="text/javascript" charset="utf-8"></script>
		<script id='categorySel' type="text/html">
			<option value="">所有状态</option>
			{{each data item}}
			<option value="{{item.id}}">{{item.name}}</option>
			{{/each}}
		</script>
		<script id='articleList' type="text/html">
			{{each data item}}
			<tr>
				<td>{{item.title}}</td>
				<td>{{item.author}}</td>
				<td>{{item.type}}</td>
				<td class="text-center">{{item.date}}</td>
				<td class="text-center">{{item.state}}</td>
				<td class="text-center">
					<a href="./article_edit.html?id={{item.id}}&name='旋风狗'" class="btn btn-default btn-xs">编辑</a>
					<a href="javascript:;" class="btn btn-danger btn-xs" data-id="{{item.id}}">删除</a>
				</td>
			</tr>
			{{/each}}
		</script>
		<script>
			// 设置左侧菜单
			$('#release_btn').click(function() {
				window.parent.setMenu(1, 1);
			})
			$(function() {
				var key = ''; //搜索关键词，可以为空，为空返回某类型所有文章
				var type = ''; //√文章类型的编号，可以为空，为空返回所有类型文章
				var state = ''; //√文章状态，草稿或者已发布
				var currentPage = 1; //√当前页，为空返回第1页
				var perpage = 8; //√每页显示条数，为空默认每页6条
				var id = ''; //文章id，根据id查询时，其余参数可以不选择
				var newTotalPage;//记录每次的totalPage,以便判断是否与上一次不同
				//设置文章内别下拉框
				category.show(function(res) {
					if(res.code == '200') {
						var htmlStr = template('categorySel', res);
						$('#selCategory').html(htmlStr);
					} else {
						alert(res.msg);
					}
//					console.log(res);
				});
				//获取并显示数据
				function getAndshow() {
					article.show({
						key: key,
						type: type, //√
						state: state, //√
						page: currentPage, //√
						perpage: perpage,
						id: id
					}, function(res) {
//						console.log(res);
						var htmlArticleList = template('articleList', res);
						$('#listArticle').html(htmlArticleList);
						
					  // 2. 初始化分页
		              // 更改查询条件之后，totalPages并没有更新
		              // 如果本次查询得到的totalPages与上一次不同，则销毁重建
						if (res.totalPage != newTotalPage) {
							newTotalPage=res.totalPage;
							$('#pagination-demo').twbsPagination('destroy');
						} 
						
						//不能用totalPage=res.totalPage讲分页事件写在ajax请求外面，
						//因为ajax是异步的，写在函数外面可能就获取不到res.totalPage了
						//而且筛选时，totalPages也要更新
						$('#pagination-demo').twbsPagination({
											totalPages: res.totalPage,
											visiblePages: 7,
											first: '第一页',
											prev: '上一页',
											next: '下一页',
											last: '最后一页',
											onPageClick: function(event, page) {
												$('#page-content').text('Page ' + page);
//												console.log(page);
												currentPage=page;
												getAndshow();
											}
										});
									});
				}
				
				//进页面显示数据
				getAndshow();
				//筛选
				function selectArticle(){
					type=$('#selCategory').val();
					state=$('#selStatus').val();
					if (state == 'drafted') {
						state='草稿';
					} else if(state == 'published'){
						state='已发布';
					}
					console.log('type:'+type);
					console.log('state:'+state);
					getAndshow();
				}
				$('#btnSearch').click(function(){
					selectArticle();
				});
				//删除
			$('#listArticle').on('click','td a:last-of-type',function(){
//				var id=$(this).attr('data-id');
				var id=$(this).data('id');
				var delDom=$(this).parents('tr');
				console.log(id);
				//不用闭包是因为页面要一直保持有8条数据
//				(function(delDom){
//					article.delete(id,function(res){
//					alert(res.msg);
//					delDom.hide();
//				});
//				})(delDom);
				article.delete(id,function(res){
					console.log(res);
					if (res.code == '200') {
						getAndshow();
					} else{
						alert(res.msg);
					}
				});
				
			});
			//编辑
//		    $('#listArticle').on('click','td a:first-of-type',function(){
//		    	
//		    });
			});
			
		</script>

	</body>

</html>